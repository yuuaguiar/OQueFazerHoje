{% extends 'gestao/base.html' %}
{% load static %}

{% block title %}Dashboard - O Que Fazer Hoje.{% endblock %}

{% block content %}
<main>
    {% if not user.is_authenticated %}
        <div class="card" style="text-align: center;">
            <h2 class="tasks-title">Bem-vindo(a)!</h2>
            <p>Faça login ou crie uma conta para organizar suas tarefas diárias.</p>
        </div>

    {% elif all_completed %}
        <div class="completion-message">
            <i data-lucide="sparkles" class="icon"></i>
            <h3 class="completion-message-title">Tudo limpo por hoje!</h3>
            <p class="completion-message-text">
                Parabéns! Você completou todas as tarefas de hoje.
            </p>
            
            <button onclick="toggleRevisao()" class="btn btn-outline" style="margin-top: 1.5rem; border-color: hsl(var(--primary)); color: hsl(var(--primary));">
                <i data-lucide="list-checks" style="width: 16px; margin-right: 8px; display: inline-block; vertical-align: middle;"></i>
                Revisar Tarefas Concluídas
            </button>
        </div>

        <div id="lista-revisao" class="hidden" style="margin-top: 2rem;">
            <h3 class="tasks-title" style="font-size: 1.1rem; text-align: center;">Clique para desmarcar</h3>
            <div class="tasks-grid">
                {% for task in tarefas_hoje %}
                    <form action="{% url 'concluir_tarefa' task.id %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="task-card" data-completed="true">
                            <div class="task-card-content">
                                <div>
                                    <h3 class="task-card-title">{{ task.titulo }}</h3>
                                    <p class="task-card-room">Cômodo: {{ task.comodo.nome }}</p>
                                </div>
                                <i data-lucide="check" class="task-card-icon"></i>
                            </div>
                        </button>
                    </form>
                {% endfor %}
            </div>
        </div>

    {% else %}
        <div class="card gamification-grid">
            <div class="progress-bar-area">
                <h3 class="progress-bar-title">Seu Progresso de Hoje</h3>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" style="width: {{ progresso_percentual }}%;"></div>
                </div>
                <p class="progress-bar-label">
                    {{ tarefas_concluidas_count }} de {{ tarefas_hoje_count }} tarefas concluídas
                </p>
            </div>
            <div class="streak-display">
                <h3 class="streak-title">Sequência</h3>
                <div class="streak-value">
                    <i data-lucide="flame" class="icon"></i>
                    <span>{{ perfil.streak_atual }}</span>
                </div>
                <p class="streak-label">dias</p>
            </div>
        </div>

        <section class="tasks-section">
            <h2 class="tasks-title">O Que Fazer Hoje</h2>
            <div class="tasks-grid">
                {% for task in tarefas_hoje %}
                    <form id="form-task-{{ task.id }}" action="{% url 'concluir_tarefa' task.id %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" 
                                class="task-card js-task-btn" 
                                data-id="{{ task.id }}"
                                data-completed="{{ task.is_completed_today|yesno:'true,false' }}"
                                onclick="verificarConclusao(event, '{{ task.id }}', '{{ task.is_completed_today|yesno:'true,false' }}')">
                            <div class="task-card-content">
                                <div>
                                    <h3 class="task-card-title">{{ task.titulo }}</h3>
                                    <p class="task-card-room">Cômodo: {{ task.comodo.nome }}</p>
                                </div>
                                {% if task.is_completed_today %}
                                    <i data-lucide="check" class="task-card-icon"></i>
                                {% endif %}
                            </div>
                        </button>
                    </form>
                {% empty %}
                    <p>Nenhuma tarefa pendente para hoje. Aproveite o dia!</p>
                {% endfor %}
            </div>
        </section>
    {% endif %}

    <div class="ad-block">
        <p class="ad-block-label">Publicidade</p>
        <div class="ad-block-box" style="border: none; background: none; height: auto;">
            <img src="https://placehold.co/728x90/2d2d2d/FFF?text=Google+Ads+Banner+(Exemplo)" 
                 alt="Anúncio Publicitário" 
                 style="width: 100%; max-width: 728px; height: auto; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
        </div>
    </div>

    <div id="modal-add-comodo" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar Novo Cômodo</h3>
                <button type="button" class="modal-close-btn" onclick="fecharModal('modal-add-comodo')">
                    <i data-lucide="x" class="icon"></i>
                </button>
            </div>
            
            <form action="{% url 'add_comodo' %}" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div>
                        <label for="id_nome_comodo" class="form-label">Nome do Cômodo</label>
                        <input type="text" name="nome" id="id_nome_comodo" placeholder="Ex: Cozinha, Quarto..." class="form-input" required>
                        <input type="hidden" name="icone" value="default.png">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="fecharModal('modal-add-comodo')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar Cômodo</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-add-tarefa" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar Nova Tarefa</h3>
                <button type="button" class="modal-close-btn" onclick="fecharModal('modal-add-tarefa')">
                    <i data-lucide="x" class="icon"></i>
                </button>
            </div>
            
            <form action="{% url 'add_tarefa' %}" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div>
                        <label for="id_titulo_tarefa" class="form-label">Nome da Tarefa</label>
                        <input type="text" name="titulo" id="id_titulo_tarefa" placeholder="Ex: Lavar a louça" class="form-input" required>
                    </div>
                    <div class="config-form-grid">
                        <div>
                            <label for="id_comodo_tarefa" class="form-label">Cômodo</label>
                            <select name="comodo_id" id="id_comodo_tarefa" class="form-select" required>
                                {% for comodo in comodos %}
                                <option value="{{ comodo.id }}">{{ comodo.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="id_intervalo_tarefa" class="form-label">Frequência (dias)</label>
                            <input type="number" name="intervalo_dias" value="1" min="1" id="id_intervalo_tarefa" class="form-input" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="fecharModal('modal-add-tarefa')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar Tarefa</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-confirm-finish" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Quase lá!</h3>
                <button type="button" class="modal-close-btn" onclick="fecharModal('modal-confirm-finish')">
                    <i data-lucide="x" class="icon"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Você realmente concluiu todas as tarefas de hoje?</p>
                <p style="font-size: 0.9rem; color: hsl(var(--muted-foreground));">Ao confirmar, sua sequência diária aumentará!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="fecharModal('modal-confirm-finish')">Ainda não</button>
                <button type="button" class="btn btn-primary" onclick="confirmarConclusao()">Sim, completei tudo!</button>
            </div>
        </div>
    </div>

</main>

<script>
    let tarefaPendenteId = null;

    // Função para mostrar a lista oculta na tela de sucesso
    function toggleRevisao() {
        const lista = document.getElementById('lista-revisao');
        if (lista.classList.contains('hidden')) {
            lista.classList.remove('hidden');
        } else {
            lista.classList.add('hidden');
        }
    }

    function verificarConclusao(event, id, isCompletedStr) {
        const isCompleted = isCompletedStr === 'true';

        // Se já está concluída, é desmarcar. Permite.
        if (isCompleted) {
            return true; 
        }

        // Conta quantas tarefas faltam ser marcadas (que estão brancas)
        const tarefasPendentes = document.querySelectorAll('.js-task-btn[data-completed="false"]').length;

        // Se for a última, pede confirmação
        if (tarefasPendentes === 1) {
            event.preventDefault();
            tarefaPendenteId = id;
            const modal = document.getElementById('modal-confirm-finish');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            return false;
        }
        return true;
    }

    function confirmarConclusao() {
        if (tarefaPendenteId) {
            const form = document.getElementById('form-task-' + tarefaPendenteId);
            if (form) {
                form.submit();
            }
        }
    }

    function fecharModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }
    
    if (typeof lucide !== "undefined") {
        lucide.createIcons();
    }
</script>
{% endblock %}
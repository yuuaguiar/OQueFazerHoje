{% extends 'gestao/base.html' %}
{% load static %}

{% block title %}Dashboard - O Que Fazer Hoje.{% endblock %}

{% block content %}
<main>
    {% if not user.is_authenticated %}
        <div class="card" style="text-align: center;">
            <h2 class="tasks-title">Bem-vindo(a)!</h2>
            <p>Faça login ou crie uma conta para organizar suas tarefas diárias.</p>
        </div>
    {% elif all_completed %}
        <div class="completion-message">
            <i data-lucide="sparkles" class="icon"></i>
            <h3 class="completion-message-title">Tudo limpo por hoje! ✨</h3>
            <p class="completion-message-text">
                Parabéns! Você completou todas as tarefas de hoje.
            </p>
        </div>
    {% else %}
        <div class="card gamification-grid">
            <div class="progress-bar-area">
                <h3 class="progress-bar-title">Seu Progresso de Hoje</h3>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" style="width: {{ progresso_percentual }}%;"></div>
                </div>
                <p class="progress-bar-label">
                    {{ tarefas_concluidas_count }} de {{ tarefas_hoje_count }} tarefas concluídas
                </p>
            </div>
            
            <div class="streak-display">
                <h3 class="streak-title">Sequência</h3>
                <div class="streak-value">
                    <i data-lucide="flame" class="icon"></i>
                    <span>{{ perfil.streak_atual }}</span>
                </div>
                <p class="streak-label">dias</p>
            </div>
        </div>

        <section class="tasks-section">
            <h2 class="tasks-title">O Que Fazer Hoje</h2>
            
            <div class="tasks-grid">
                {% for task in tarefas_hoje %}
                    <form action="{% url 'concluir_tarefa' task.id %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="task-card" data-completed="{{ task.is_completed_today|yesno:'true,false' }}">
                            <div class="task-card-content">
                                <div>
                                    <h3 class="task-card-title">{{ task.titulo }}</h3>
                                    <p class="task-card-room">Cômodo: {{ task.comodo.nome }}</p>
                                </div>
                                
                                {% if task.is_completed_today %}
                                    <i data-lucide="check" class="task-card-icon"></i>
                                {% endif %}
                            </div>
                        </button>
                    </form>
                {% empty %}
                    <p>Nenhuma tarefa pendente para hoje. Aproveite o dia!</p>
                {% endfor %}
            </div>
        </section>
    {% endif %}

    <div class="ad-block">
        <p class="ad-block-label">Publicidade</p>
        <div class="ad-block-box">
            <p>Espaço para anúncio</p>
        </div>
    </div>
</main>
{% endblock %}

<div id="modal-add-comodo" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Adicionar Novo Cômodo</h3>
            <button class="modal-close-btn" data-dismiss="modal">
                <i data-lucide="x" class="icon"></i>
            </button>
        </div>
        
        <form action="{% url 'add_comodo' %}" method="POST">
            {% csrf_token %}
            <div class="modal-body">
                <div>
                    <label for="id_nome_comodo" class="form-label">Nome do Cômodo</label>
                    <input type="text" name="nome" id="id_nome_comodo" placeholder="Ex: Cozinha, Quarto..." class="form-input" required>
                    <input type="hidden" name="icone" value="default.png">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" data-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Adicionar Cômodo</button>
            </div>
        </form>
    </div>
</div>

<div id="modal-add-tarefa" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Adicionar Nova Tarefa</h3>
            <button class="modal-close-btn" data-dismiss="modal">
                <i data-lucide="x" class="icon"></i>
            </button>
        </div>
        
        <form action="{% url 'add_tarefa' %}" method="POST">
            {% csrf_token %}
            <div class="modal-body">
                <div>
                    <label for="id_titulo_tarefa" class="form-label">Nome da Tarefa</label>
                    <input type="text" name="titulo" id="id_titulo_tarefa" placeholder="Ex: Lavar a louça" class="form-input" required>
                </div>
                <div class="config-form-grid">
                    <div>
                        <label for="id_comodo_tarefa" class="form-label">Cômodo</label>
                        <select name="comodo_id" id="id_comodo_tarefa" class="form-select" required>
                            {% for comodo in comodos %}
                            <option value="{{ comodo.id }}">{{ comodo.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="id_intervalo_tarefa" class="form-label">Frequência (dias)</label>
                        <input type="number" name="intervalo_dias" value="1" min="1" id="id_intervalo_tarefa" class="form-input" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" data-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Adicionar Tarefa</button>
            </div>
        </form>
    </div>
</div>